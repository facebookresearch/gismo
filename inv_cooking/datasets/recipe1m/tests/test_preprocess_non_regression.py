from omegaconf import DictConfig

from inv_cooking.datasets.recipe1m.preprocess import build_vocab_recipe1m


def test_non_regression():
    dets = [
        {
            "id": "000018c8a5",
            "valid": [
                True,
                True,
                True,
                True,
                True,
                True,
                True,
                True,
                False,
                False,
                True,
                True,
                True,
                False,
            ],
            "ingredients": [
                {"text": "penne"},
                {"text": "cheese sauce"},
                {"text": "cheddar cheese"},
                {"text": "gruyere cheese"},
                {"text": "dried chipotle powder"},
                {"text": "unsalted butter"},
                {"text": "all - purpose flour"},
                {"text": "milk"},
                {
                    "text": "14 ounces semihard cheese (page 23), grated (about 3 1/2 cups)"
                },
                {"text": "2 ounces semisoft cheese (page 23), grated (1/2 cup)"},
                {"text": "kosher salt"},
                {"text": "dried chipotle powder"},
                {"text": "garlic powder"},
                {"text": "(makes about 4 cups)"},
            ],
        }
    ]

    layer1 = [
        {
            "id": "000018c8a5",
            "title": "Worlds Best Mac and Cheese",
            "partition": "train",
            "url": "http://www.epicurious.com/recipes/food/views/-world-s-best-mac-and-cheese-387747",
            "ingredients": [
                {"text": "6 ounces penne"},
                {"text": "2 cups Beechers Flagship Cheese Sauce (recipe follows)"},
                {"text": "1 ounce Cheddar, grated (1/4 cup)"},
                {"text": "1 ounce Gruyere cheese, grated (1/4 cup)"},
                {"text": "1/4 to 1/2 teaspoon chipotle chili powder (see Note)"},
                {"text": "1/4 cup (1/2 stick) unsalted butter"},
                {"text": "1/3 cup all-purpose flour"},
                {"text": "3 cups milk"},
                {
                    "text": "14 ounces semihard cheese (page 23), grated (about 3 1/2 cups)"
                },
                {"text": "2 ounces semisoft cheese (page 23), grated (1/2 cup)"},
                {"text": "1/2 teaspoon kosher salt"},
                {"text": "1/4 to 1/2 teaspoon chipotle chili powder"},
                {"text": "1/8 teaspoon garlic powder"},
                {"text": "(makes about 4 cups)"},
            ],
            "instructions": [
                {
                    "text": "Preheat the oven to 350 F. Butter or oil an 8-inch baking dish."
                },
                {"text": "Cook the penne 2 minutes less than package directions."},
                {"text": "(It will finish cooking in the oven.)"},
                {"text": "Rinse the pasta in cold water and set aside."},
                {
                    "text": "Combine the cooked pasta and the sauce in a medium bowl and mix carefully but thoroughly."
                },
                {"text": "Scrape the pasta into the prepared baking dish."},
                {
                    "text": "Sprinkle the top with the cheeses and then the chili powder."
                },
                {"text": "Bake, uncovered, for 20 minutes."},
                {"text": "Let the mac and cheese sit for 5 minutes before serving."},
                {
                    "text": "Melt the butter in a heavy-bottomed saucepan over medium heat and whisk in the flour."
                },
                {"text": "Continue whisking and cooking for 2 minutes."},
                {"text": "Slowly add the milk, whisking constantly."},
                {
                    "text": "Cook until the sauce thickens, about 10 minutes, stirring frequently."
                },
                {"text": "Remove from the heat."},
                {"text": "Add the cheeses, salt, chili powder, and garlic powder."},
                {
                    "text": "Stir until the cheese is melted and all ingredients are incorporated, about 3 minutes."
                },
                {"text": "Use immediately, or refrigerate for up to 3 days."},
                {
                    "text": "This sauce reheats nicely on the stove in a saucepan over low heat."
                },
                {"text": "Stir frequently so the sauce doesnt scorch."},
                {
                    "text": "This recipe can be assembled before baking and frozen for up to 3 monthsjust be sure to use a freezer-to-oven pan and increase the baking time to 50 minutes."
                },
                {
                    "text": "One-half teaspoon of chipotle chili powder makes a spicy mac, so make sure your family and friends can handle it!"
                },
                {
                    "text": "The proportion of pasta to cheese sauce is crucial to the success of the dish."
                },
                {
                    "text": "It will look like a lot of sauce for the pasta, but some of the liquid will be absorbed."
                },
            ],
        }
    ]

    layer2 = [
        {
            "id": "000018c8a5",
            "images": [
                {
                    "id": "3e233001e2.jpg",
                    "url": "http://img.sndimg.com/food/image/upload/w_512,h_512,c_fit,fl_progressive,q_95/v1/img/recipes/47/91/49/picaYYmb9.jpg",
                },
                {
                    "id": "7f749987f9.jpg",
                    "url": "http://img.sndimg.com/food/image/upload/w_512,h_512,c_fit,fl_progressive,q_95/v1/img/recipes/47/91/49/picpy37SW.jpg",
                },
                {
                    "id": "aaf6b2dcd3.jpg",
                    "url": "http://img.sndimg.com/food/image/upload/w_512,h_512,c_fit,fl_progressive,q_95/v1/img/recipes/47/91/49/picX9CNE2.jpg",
                },
            ],
        }
    ]

    config = DictConfig(
        {
            "threshold_ingrs": 1,  # minimum ingr count threshold
            "threshold_words": 1,  # minimum word count threshold
            "maxnuminstrs": 100,  # max number of instructions (sentences)
            "maxnumingrs": 100,  # max number of ingredients
            "minnuminstrs": 1,  # min number of instructions (sentences)
            "minnumingrs": 1,  # min number of ingredients
            "minnumwords": 1,  # minimum number of characters in recipe)
        }
    )

    vocab_ingrs, vocab_toks, dataset = build_vocab_recipe1m(
        dets, layer1, layer2, config
    )

    assert vocab_ingrs.word2idx == {
        "<end>": 0,
        "penne": 1,
        "cheese_sauce": 2,
        "cheddar_cheese": 3,
        "gruyere_cheese": 4,
        "dried_chipotle_powder": 5,
        "unsalted_butter": 6,
        "all_-_purpose_flour": 7,
        "milk": 8,
        "milk_powder": 8,
        "kosher_salt": 9,
        "garlic_powder": 10,
        "peppers": 11,
        "tomato": 12,
        "tomato_sauce": 12,
        "spinach_leaves": 13,
        "turkey_breast": 14,
        "lettuce_leaf": 15,
        "chicken_thighs": 16,
        "bread_crumbs": 17,
        "onion_flakes": 18,
        "red_pepper": 19,
        "pepper_flakes": 20,
        "juice_concentrate": 21,
        "cracker_crumbs": 22,
        "hot_chili": 23,
        "seasoning_mix": 24,
        "dill_weed": 25,
        "pepper_sauce": 26,
        "sprouts": 27,
        "cooking_spray": 28,
        "cheese_blend": 29,
        "basil_leaves": 30,
        "pineapple_chunks": 31,
        "marshmallow": 32,
        "chile_powder": 33,
        "corn_kernels": 34,
        "chickens": 35,
        "cracker_crust": 36,
        "lemonade_concentrate": 37,
        "red_chili": 38,
        "mushroom_cap": 39,
        "mushroom_caps": 39,
        "breaded_chicken": 40,
        "frozen_pineapple": 41,
        "seaweed": 42,
        "bouillon_granules": 43,
        "stuffing_mix": 44,
        "parsley_flakes": 45,
        "chicken_breast": 46,
        "baguettes": 47,
        "green_tea": 48,
        "peanut_butter": 49,
        "green_onion": 50,
        "fresh_cilantro": 51,
        "hot_pepper": 52,
        "dried_lavender": 53,
        "white_chocolate": 54,
        "cake_mix": 55,
        "cheese_spread": 56,
        "chucken_thighs": 57,
        "mandarin_orange": 58,
        "laurel": 59,
        "cabbage_head": 60,
        "pistachio": 61,
        "cheese_dip": 62,
        "thyme_leave": 63,
        "boneless_pork": 64,
        "onion_dip": 65,
        "skinless_chicken": 66,
        "dark_chocolate": 67,
        "canned_corn": 68,
        "muffin": 69,
        "frozen_broccoli": 70,
        "philadelphia": 71,
        "<pad>": 72,
    }
    assert vocab_toks.word2idx == {
        "<start>": 0,
        "<end>": 1,
        "<eoi>": 2,
        "preheat": 3,
        "the": 4,
        "oven": 5,
        "to": 6,
        "350": 7,
        "f.": 8,
        "butter": 9,
        "or": 10,
        "oil": 11,
        "an": 12,
        "8-inch": 13,
        "baking": 14,
        "dish": 15,
        ".": 16,
        "cook": 17,
        "penne": 18,
        "2": 19,
        "minutes": 20,
        "less": 21,
        "than": 22,
        "package": 23,
        "directions": 24,
        "(": 25,
        "it": 26,
        "will": 27,
        "finish": 28,
        "cooking": 29,
        "in": 30,
        ")": 31,
        "rinse": 32,
        "pasta": 33,
        "cold": 34,
        "water": 35,
        "and": 36,
        "set": 37,
        "aside": 38,
        "combine": 39,
        "cooked": 40,
        "sauce": 41,
        "a": 42,
        "medium": 43,
        "bowl": 44,
        "mix": 45,
        "carefully": 46,
        "but": 47,
        "thoroughly": 48,
        "scrape": 49,
        "into": 50,
        "prepared": 51,
        "sprinkle": 52,
        "top": 53,
        "with": 54,
        "cheeses": 55,
        "then": 56,
        "chili": 57,
        "powder": 58,
        "bake": 59,
        ",": 60,
        "uncovered": 61,
        "for": 62,
        "20": 63,
        "let": 64,
        "mac": 65,
        "cheese": 66,
        "sit": 67,
        "5": 68,
        "before": 69,
        "serving": 70,
        "melt": 71,
        "heavy-bottomed": 72,
        "saucepan": 73,
        "over": 74,
        "heat": 75,
        "whisk": 76,
        "flour": 77,
        "continue": 78,
        "whisking": 79,
        "slowly": 80,
        "add": 81,
        "milk": 82,
        "constantly": 83,
        "until": 84,
        "thickens": 85,
        "about": 86,
        "10": 87,
        "stirring": 88,
        "frequently": 89,
        "remove": 90,
        "from": 91,
        "salt": 92,
        "garlic": 93,
        "stir": 94,
        "is": 95,
        "melted": 96,
        "all": 97,
        "ingredients": 98,
        "are": 99,
        "incorporated": 100,
        "3": 101,
        "use": 102,
        "immediately": 103,
        "refrigerate": 104,
        "up": 105,
        "days": 106,
        "this": 107,
        "reheats": 108,
        "nicely": 109,
        "on": 110,
        "stove": 111,
        "low": 112,
        "so": 113,
        "doesnt": 114,
        "scorch": 115,
        "recipe": 116,
        "can": 117,
        "be": 118,
        "assembled": 119,
        "frozen": 120,
        "monthsjust": 121,
        "sure": 122,
        "freezer-to-oven": 123,
        "pan": 124,
        "increase": 125,
        "time": 126,
        "50": 127,
        "one-half": 128,
        "teaspoon": 129,
        "of": 130,
        "chipotle": 131,
        "makes": 132,
        "spicy": 133,
        "make": 134,
        "your": 135,
        "family": 136,
        "friends": 137,
        "handle": 138,
        "!": 139,
        "proportion": 140,
        "crucial": 141,
        "success": 142,
        "look": 143,
        "like": 144,
        "lot": 145,
        "some": 146,
        "liquid": 147,
        "absorbed": 148,
        "worlds": 149,
        "best": 150,
        "<pad>": 151,
    }
    assert len(dataset["train"]) == 1
    assert len(dataset["test"]) == 0
    assert len(dataset["val"]) == 0
    assert dataset["train"][0] == {
        "id": "000018c8a5",
        "instructions": [
            "preheat the oven to 350 f. butter or oil an 8-inch baking dish.",
            "cook the penne 2 minutes less than package directions.",
            "(it will finish cooking in the oven.)",
            "rinse the pasta in cold water and set aside.",
            "combine the cooked pasta and the sauce in a medium bowl and mix carefully but thoroughly.",
            "scrape the pasta into the prepared baking dish.",
            "sprinkle the top with the cheeses and then the chili powder.",
            "bake, uncovered, for 20 minutes.",
            "let the mac and cheese sit for 5 minutes before serving.",
            "melt the butter in a heavy-bottomed saucepan over medium heat and whisk in the flour.",
            "continue whisking and cooking for 2 minutes.",
            "slowly add the milk, whisking constantly.",
            "cook until the sauce thickens, about 10 minutes, stirring frequently.",
            "remove from the heat.",
            "add the cheeses, salt, chili powder, and garlic powder.",
            "stir until the cheese is melted and all ingredients are incorporated, about 3 minutes.",
            "use immediately, or refrigerate for up to 3 days.",
            "this sauce reheats nicely on the stove in a saucepan over low heat.",
            "stir frequently so the sauce doesnt scorch.",
            "this recipe can be assembled before baking and frozen for up to 3 monthsjust be sure to use a freezer-to-oven pan and increase the baking time to 50 minutes.",
            "one-half teaspoon of chipotle chili powder makes a spicy mac, so make sure your family and friends can handle it!",
            "the proportion of pasta to cheese sauce is crucial to the success of the dish.",
            "it will look like a lot of sauce for the pasta, but some of the liquid will be absorbed.",
        ],
        "tokenized": [
            [
                "preheat",
                "the",
                "oven",
                "to",
                "350",
                "f.",
                "butter",
                "or",
                "oil",
                "an",
                "8-inch",
                "baking",
                "dish",
                ".",
            ],
            [
                "cook",
                "the",
                "penne",
                "2",
                "minutes",
                "less",
                "than",
                "package",
                "directions",
                ".",
            ],
            ["(", "it", "will", "finish", "cooking", "in", "the", "oven", ".", ")"],
            [
                "rinse",
                "the",
                "pasta",
                "in",
                "cold",
                "water",
                "and",
                "set",
                "aside",
                ".",
            ],
            [
                "combine",
                "the",
                "cooked",
                "pasta",
                "and",
                "the",
                "sauce",
                "in",
                "a",
                "medium",
                "bowl",
                "and",
                "mix",
                "carefully",
                "but",
                "thoroughly",
                ".",
            ],
            [
                "scrape",
                "the",
                "pasta",
                "into",
                "the",
                "prepared",
                "baking",
                "dish",
                ".",
            ],
            [
                "sprinkle",
                "the",
                "top",
                "with",
                "the",
                "cheeses",
                "and",
                "then",
                "the",
                "chili",
                "powder",
                ".",
            ],
            ["bake", ",", "uncovered", ",", "for", "20", "minutes", "."],
            [
                "let",
                "the",
                "mac",
                "and",
                "cheese",
                "sit",
                "for",
                "5",
                "minutes",
                "before",
                "serving",
                ".",
            ],
            [
                "melt",
                "the",
                "butter",
                "in",
                "a",
                "heavy-bottomed",
                "saucepan",
                "over",
                "medium",
                "heat",
                "and",
                "whisk",
                "in",
                "the",
                "flour",
                ".",
            ],
            ["continue", "whisking", "and", "cooking", "for", "2", "minutes", "."],
            ["slowly", "add", "the", "milk", ",", "whisking", "constantly", "."],
            [
                "cook",
                "until",
                "the",
                "sauce",
                "thickens",
                ",",
                "about",
                "10",
                "minutes",
                ",",
                "stirring",
                "frequently",
                ".",
            ],
            ["remove", "from", "the", "heat", "."],
            [
                "add",
                "the",
                "cheeses",
                ",",
                "salt",
                ",",
                "chili",
                "powder",
                ",",
                "and",
                "garlic",
                "powder",
                ".",
            ],
            [
                "stir",
                "until",
                "the",
                "cheese",
                "is",
                "melted",
                "and",
                "all",
                "ingredients",
                "are",
                "incorporated",
                ",",
                "about",
                "3",
                "minutes",
                ".",
            ],
            [
                "use",
                "immediately",
                ",",
                "or",
                "refrigerate",
                "for",
                "up",
                "to",
                "3",
                "days",
                ".",
            ],
            [
                "this",
                "sauce",
                "reheats",
                "nicely",
                "on",
                "the",
                "stove",
                "in",
                "a",
                "saucepan",
                "over",
                "low",
                "heat",
                ".",
            ],
            ["stir", "frequently", "so", "the", "sauce", "doesnt", "scorch", "."],
            [
                "this",
                "recipe",
                "can",
                "be",
                "assembled",
                "before",
                "baking",
                "and",
                "frozen",
                "for",
                "up",
                "to",
                "3",
                "monthsjust",
                "be",
                "sure",
                "to",
                "use",
                "a",
                "freezer-to-oven",
                "pan",
                "and",
                "increase",
                "the",
                "baking",
                "time",
                "to",
                "50",
                "minutes",
                ".",
            ],
            [
                "one-half",
                "teaspoon",
                "of",
                "chipotle",
                "chili",
                "powder",
                "makes",
                "a",
                "spicy",
                "mac",
                ",",
                "so",
                "make",
                "sure",
                "your",
                "family",
                "and",
                "friends",
                "can",
                "handle",
                "it",
                "!",
            ],
            [
                "the",
                "proportion",
                "of",
                "pasta",
                "to",
                "cheese",
                "sauce",
                "is",
                "crucial",
                "to",
                "the",
                "success",
                "of",
                "the",
                "dish",
                ".",
            ],
            [
                "it",
                "will",
                "look",
                "like",
                "a",
                "lot",
                "of",
                "sauce",
                "for",
                "the",
                "pasta",
                ",",
                "but",
                "some",
                "of",
                "the",
                "liquid",
                "will",
                "be",
                "absorbed",
                ".",
            ],
        ],
        "ingredients": [
            "penne",
            "cheese_sauce",
            "cheddar_cheese",
            "gruyere_cheese",
            "dried_chipotle_powder",
            "unsalted_butter",
            "all_-_purpose_flour",
            "milk",
            "kosher_salt",
            "dried_chipotle_powder",
            "garlic_powder",
        ],
        "images": ["3e233001e2.jpg", "7f749987f9.jpg", "aaf6b2dcd3.jpg"],
        "title": ["worlds", "best", "mac", "and", "cheese"],
    }
